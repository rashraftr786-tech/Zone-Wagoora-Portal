<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zone Wagoora | Learning Portal</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; overscroll-behavior-y: contain; }
        .app-gradient { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); }
        .input-style { @apply w-full p-4 rounded-2xl bg-slate-100 border-none focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-sm font-semibold; }
        .quiz-option { @apply w-full p-4 bg-white border-2 border-slate-100 rounded-2xl text-left font-bold text-slate-600 active:scale-95 transition-all mb-3; }
        .profile-img { @apply w-12 h-12 rounded-full object-cover border-2 border-indigo-100; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl p-8 border border-slate-100">
            <div id="signup-box" class="hidden space-y-4">
                <h2 class="text-xl font-black text-center mb-4">Create Account</h2>
                
                <div class="flex flex-col items-center mb-4">
                    <label for="reg-photo" class="cursor-pointer">
                        <div id="photo-preview" class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center border-2 border-dashed border-slate-300 overflow-hidden">
                            <i class="fas fa-camera text-slate-400 text-xl"></i>
                        </div>
                    </label>
                    <input type="file" id="reg-photo" accept="image/*" class="hidden" onchange="previewImage(event)">
                    <p class="text-[10px] font-bold text-slate-400 mt-2 uppercase">Upload Student Photo</p>
                </div>

                <input type="text" id="reg-name" placeholder="Full Name" class="input-style">
                <input type="tel" id="reg-whatsapp" placeholder="WhatsApp Number" class="input-style">
                <input type="text" id="reg-school" placeholder="School Name" class="input-style">
                <select id="reg-grade" class="input-style font-bold">
                    <option value="1st">Class 1st</option><option value="2nd">Class 2nd</option><option value="3rd">Class 3rd</option>
                    <option value="4th">Class 4th</option><option value="5th">Class 5th</option><option value="6th">Class 6th</option>
                    <option value="7th">Class 7th</option><option value="8th">Class 8th</option>
                </select>
                <input type="email" id="reg-email" placeholder="Email" class="input-style">
                <input type="password" id="reg-pass" placeholder="Password" class="input-style">
                
                <button id="reg-btn" onclick="handleSignup()" class="w-full bg-slate-800 text-white font-bold py-4 rounded-2xl shadow-lg">Register & Upload</button>
                <p class="text-center text-sm text-slate-500">Back to <span onclick="toggleView()" class="text-indigo-600 font-bold cursor-pointer">Login</span></p>
            </div>
            
            <div id="login-box" class="space-y-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 app-gradient rounded-3xl mx-auto mb-4 flex items-center justify-center"><i class="fas fa-graduation-cap text-white text-2xl"></i></div>
                    <h1 class="text-2xl font-black">Zone Wagoora</h1>
                </div>
                <input type="email" id="login-email" placeholder="Email" class="input-style">
                <input type="password" id="login-pass" placeholder="Password" class="input-style">
                <button onclick="handleLogin()" class="w-full app-gradient text-white font-bold py-4 rounded-2xl shadow-lg">Sign In</button>
                <p class="text-center text-sm text-slate-500">New? <span onclick="toggleView()" class="text-indigo-600 font-bold cursor-pointer">Register</span></p>
            </div>
        </div>
    </div>

    <div id="app-dashboard" class="hidden min-h-screen pb-32">
        <div class="app-gradient p-8 pb-20 rounded-b-[3rem] text-white flex justify-between items-center">
            <div>
                <h2 id="user-name" class="text-2xl font-black">Hi!</h2>
                <p id="user-subtext" class="text-xs opacity-80 uppercase tracking-widest font-bold"></p>
            </div>
            <img id="user-avatar" src="https://ui-avatars.com/api/?name=User" class="w-16 h-16 rounded-2xl border-4 border-white/20 object-cover shadow-lg">
        </div>
        
        <div id="tab-rewards" class="hidden px-6 mt-6">
            <h3 class="font-black text-slate-800 uppercase text-xs mb-4">Zone Leaderboard</h3>
            <div id="leaderboard-list" class="space-y-3"></div>
        </div>
    </div>

    <script>
        // Use your existing firebaseConfig here
        const firebaseConfig = {
            apiKey: "AIzaSyBcRfUj9N_9LaVuEuIT7d0ueJ88heyP9hI",
            authDomain: "wagoora-edu-portal.firebaseapp.com",
            projectId: "wagoora-edu-portal",
            storageBucket: "wagoora-edu-portal.appspot.com", // Ensure this matches Storage tab
            messagingSenderId: "476444772096",
            appId: "1:476444772096:web:6fd360cc0a774f94a1d5e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        function previewImage(event) {
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = `<img src="${URL.createObjectURL(event.target.files[0])}" class="w-full h-full object-cover">`;
        }

        async function handleSignup() {
            const btn = document.getElementById('reg-btn');
            const file = document.getElementById('reg-photo').files[0];
            if(!file) return alert("Please upload a student photo first.");
            
            btn.innerText = "Uploading Photo...";
            btn.disabled = true;

            try {
                // 1. Create User
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-pass').value;
                const cred = await auth.createUserWithEmailAndPassword(email, pass);

                // 2. Upload Photo
                const storageRef = storage.ref(`profile_pics/${cred.user.uid}`);
                await storageRef.put(file);
                const photoURL = await storageRef.getDownloadURL();

                // 3. Save Data
                await db.collection("users").doc(cred.user.uid).set({
                    uid: cred.user.uid,
                    fullName: document.getElementById('reg-name').value,
                    whatsapp: document.getElementById('reg-whatsapp').value,
                    school: document.getElementById('reg-school').value,
                    grade: document.getElementById('reg-grade').value,
                    photoURL: photoURL,
                    coins: 0, completed: [], approved: false, role: 'student'
                });

                alert("Success! Awaiting HOI approval.");
                location.reload();
            } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "Register"; }
        }

        // Leaderboard Update to show images
        async function fetchLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = 'Loading scholars...';
            const snap = await db.collection("users").where("role","==","student").orderBy("coins","desc").limit(10).get();
            list.innerHTML = '';
            snap.forEach((doc, i) => {
                const u = doc.data();
                const d = document.createElement('div');
                d.className = "flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border border-slate-100";
                d.innerHTML = `
                    <div class="flex items-center gap-3">
                        <b class="text-slate-400 w-4">${i+1}</b>
                        <img src="${u.photoURL || 'https://ui-avatars.com/api/?name='+u.fullName}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <p class="font-bold text-sm">${u.fullName}</p>
                            <p class="text-[8px] opacity-50 uppercase">${u.school}</p>
                        </div>
                    </div>
                    <b class="text-indigo-600">${u.coins}</b>
                `;
                list.appendChild(d);
            });
        }
        
        // Ensure to call updateDashboardUI() after login to set document.getElementById('user-avatar').src = currentUser.photoURL;
    </script>
</body>
</html>
